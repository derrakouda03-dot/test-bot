MIT License

Copyright (c) 2025 derrakouda03-dot

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
/* ===================================================
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                TABLEAU DE BORD BOT            â•‘
â•‘          VERSION FINALE RENFORCÃ‰E             â•‘
â•‘      MULTILINGUE + BACKUP VPS + MINI-JEUX     â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Zone 1ï¸âƒ£ : IMPORTS & CONFIGURATION âš ï¸       â•‘
â•‘  Zone 2ï¸âƒ£ : BASE DE DONNÃ‰ES SQLITE âš ï¸        â•‘
â•‘  Zone 3ï¸âƒ£ : CONFIG BOT & VARIABLES MODIFIABLES ğŸŸ¢â•‘
â•‘  Zone 4ï¸âƒ£ : FONCTIONS UTILITAIRES ğŸŸ¢          â•‘
â•‘  Zone 5ï¸âƒ£ : Ã‰VÃ‰NEMENTS DISCORD ğŸŸ¢             â•‘
â•‘  Zone 6ï¸âƒ£ : BACKUP & STABILITÃ‰ VPS ğŸŸ¢         â•‘
â•‘  Zone 7ï¸âƒ£ : COMMANDES ADMIN & MINI-DASHBOARD ğŸŸ¢â•‘
â•‘  Zone 8ï¸âƒ£ : LOGIN BOT âš ï¸                     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
=================================================== */

/* ===================================================
1ï¸âƒ£ IMPORTS & CONFIGURATION âš ï¸
=================================================== */
require('dotenv').config();
const { Client, GatewayIntentBits, Partials, Collection } = require('discord.js');
const axios = require('axios');
const express = require('express');
const bodyParser = require('body-parser');
const sqlite3 = require('sqlite3').verbose();
const fs = require('fs');

const client = new Client({
  intents: [
    GatewayIntentBits.Guilds,
    GatewayIntentBits.GuildMessages,
    GatewayIntentBits.GuildMembers,
    GatewayIntentBits.MessageContent
  ]
});

const app = express();
app.use(bodyParser.json());
/* ===================================================
FIN 1ï¸âƒ£
=================================================== */

/* ===================================================
2ï¸âƒ£ BASE DE DONNÃ‰ES SQLITE âš ï¸
=================================================== */
const db = new sqlite3.Database('./bot.db', (err) => {
  if (err) console.error("Erreur DB:", err.message);
});

db.run(`
  CREATE TABLE IF NOT EXISTS server_config (
    server_id TEXT PRIMARY KEY,
    welcome_message TEXT,
    mod_channel TEXT,
    ticket_channel_prefix TEXT,
    lang TEXT DEFAULT 'fr'
  )
`);

db.run(`
  CREATE TABLE IF NOT EXISTS lang_admins (
    server_id TEXT,
    user_id TEXT,
    PRIMARY KEY(server_id, user_id)
  )
`);

db.run(`
  CREATE TABLE IF NOT EXISTS mini_games_scores (
    server_id TEXT,
    user_id TEXT,
    game TEXT,
    score INTEGER,
    PRIMARY KEY(server_id, user_id, game)
  )
`);
/* ===================================================
FIN 2ï¸âƒ£
=================================================== */

/* ===================================================
3ï¸âƒ£ CONFIG BOT & VARIABLES MODIFIABLES ğŸŸ¢
=================================================== */
const AUTO_ROLE = "Membre";
const BOT_ADMIN_ROLE_DEFAULT = "Bot Admin"; // RÃ´le par dÃ©faut pour contrÃ´le total
let BOT_ADMIN_ROLE = BOT_ADMIN_ROLE_DEFAULT; 

const memory = {};
const xpSystem = {};
const spamMap = new Map();
const gameChannels = {
  textOnly: [],
  imageOnly: [],
  videoOnly: []
};

const FORBIDDEN_WORDS = ["insulte1","insulte2"];
const FORBIDDEN_LINKS = ["discord.gg","bit.ly"];
/* ===================================================
FIN 3ï¸âƒ£
=================================================== */

/* ===================================================
4ï¸âƒ£ FONCTIONS UTILITAIRES ğŸŸ¢
=================================================== */
function addXP(userId) {
  if (!xpSystem[userId]) xpSystem[userId] = { xp: 0, level: 1 };
  xpSystem[userId].xp += Math.floor(Math.random() * 5) + 5;
  if (xpSystem[userId].xp >= xpSystem[userId].level * 100) {
    xpSystem[userId].xp = 0;
    xpSystem[userId].level++;
    return true;
  }
  return false;
}

function sanitize(text) {
  return text.replace(/https?:\/\/[^\s]+/g, '[link]');
}

function checkBotAdmin(member) {
  return member.roles.cache.some(r => r.name === BOT_ADMIN_ROLE);
}
/* ===================================================
FIN 4ï¸âƒ£
=================================================== */

/* ===================================================
5ï¸âƒ£ Ã‰VÃ‰NEMENTS DISCORD ğŸŸ¢
=================================================== */
// Bienvenue
client.on("guildMemberAdd", async member => {
  db.get(`SELECT welcome_message, lang FROM server_config WHERE server_id=?`, [member.guild.id], async (err,row)=>{
    const welcome = row?.welcome_message || `Bienvenue ${member.user.username} !`;
    await member.send(welcome);
  });
});

// Gestion messages texte/image/vidÃ©o
client.on("messageCreate", async message => {
  if (message.author.bot) return;

  // Spam
  const now = Date.now();
  const userData = spamMap.get(message.author.id) || { count:0, last:now };
  if (now - userData.last < 4000) {
    userData.count++;
    if (userData.count >= 5) {
      message.member.timeout(10*60*1000, "Spam dÃ©tectÃ©").catch(()=>{});
      return;
    }
  } else userData.count = 1;
  userData.last = now;
  spamMap.set(message.author.id, userData);

  // VÃ©rification salon text/image/video
  if (gameChannels.textOnly.includes(message.channel.id) && message.attachments.size > 0) {
    await message.delete().catch(()=>{});
    return message.reply("ğŸš« Ce salon est rÃ©servÃ© aux messages texte uniquement !");
  }
  if (gameChannels.imageOnly.includes(message.channel.id) && !message.attachments.some(a => a.contentType?.startsWith("image"))) {
    await message.delete().catch(()=>{});
    return message.reply("ğŸš« Ce salon est rÃ©servÃ© aux images uniquement !");
  }
  if (gameChannels.videoOnly.includes(message.channel.id) && !message.attachments.some(a => a.contentType?.startsWith("video"))) {
    await message.delete().catch(()=>{});
    return message.reply("ğŸš« Ce salon est rÃ©servÃ© aux vidÃ©os uniquement !");
  }

  // XP automatique
  addXP(message.author.id);
});

/* ===================================================
6ï¸âƒ£ BACKUP & STABILITÃ‰ VPS ğŸŸ¢
=================================================== */
setInterval(() => {
  const backupPath = `./backup_bot_${Date.now()}.db`;
  fs.copyFile('./bot.db', backupPath, (err) => {
    if (err) console.error('ğŸš¨ Erreur backup DB:', err);
    else console.log('Backup DB crÃ©Ã© :', backupPath);
  });
}, 24*60*60*1000);
/* ===================================================
FIN 6ï¸âƒ£
=================================================== */

/* ===================================================
7ï¸âƒ£ COMMANDES ADMIN & MINI-DASHBOARD ğŸŸ¢
=================================================== */
client.on('interactionCreate', async interaction => {
  if (!interaction.isChatInputCommand()) return;

  // --- DÃ©finir rÃ´le bot admin
  if (interaction.commandName === 'set-bot-admin-role') {
    if (interaction.user.id !== interaction.guild.ownerId) 
      return interaction.reply({ content: 'ğŸš¨ Seul le propriÃ©taire peut dÃ©finir le rÃ´le.', ephemeral: true });
    const roleName = interaction.options.getString('role');
    BOT_ADMIN_ROLE = roleName;
    return interaction.reply(`âœ… RÃ´le de contrÃ´le total dÃ©fini sur : ${roleName}`);
  }

  // VÃ©rification Bot Admin pour commandes sensibles
  const sensitiveCommands = ['reset-scores','configure-salon','set-welcome','set-ticket-prefix'];
  if (sensitiveCommands.includes(interaction.commandName)) {
    if (!checkBotAdmin(interaction.member)) {
      return interaction.reply({ content: 'ğŸš¨ Vous nâ€™Ãªtes pas autorisÃ© Ã  utiliser cette commande.', ephemeral: true });
    }
  }

  // --- Mini-dashboard
  if (interaction.commandName === 'dashboard') {
    const embed = {
      color: 0x00ff99,
      title: `ğŸ“Š Dashboard - ${interaction.guild.name}`,
      fields: [
        { name: "Membres", value: `${interaction.guild.memberCount}`, inline: true },
        { name: "RÃ´le admin bot", value: BOT_ADMIN_ROLE, inline: true }
      ],
      timestamp: new Date()
    };
    return interaction.reply({ embeds: [embed], ephemeral: true });
  }
});
/* ===================================================
FIN 7ï¸âƒ£
=================================================== */

/* ===================================================
8ï¸âƒ£ LOGIN BOT âš ï¸
=================================================== */
client.login(process.env.DISCORD_TOKEN)
  .then(() => console.log('Bot connectÃ© âœ…'))
  .catch(err => console.error('ğŸš¨ Erreur login bot:', err));
/* ===================================================
FIN 8ï¸âƒ£
=================================================== */
