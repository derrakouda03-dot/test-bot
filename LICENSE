MIT License

Copyright (c) 2025 derrakouda03-dot

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
/* ===================================================
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                TABLEAU DE BORD BOT            ‚ïë
‚ïë          VERSION FINALE RENFORC√âE             ‚ïë
‚ïë      MULTILINGUE + BACKUP VPS + MINI-JEUX     ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë  Zone 1Ô∏è‚É£ : IMPORTS & CONFIGURATION ‚ö†Ô∏è       ‚ïë
‚ïë  Zone 2Ô∏è‚É£ : BASE DE DONN√âES SQLITE ‚ö†Ô∏è        ‚ïë
‚ïë  Zone 3Ô∏è‚É£ : CONFIG BOT & VARIABLES MODIFIABLES üü¢‚ïë
‚ïë  Zone 4Ô∏è‚É£ : FONCTIONS UTILITAIRES üü¢          ‚ïë
‚ïë  Zone 5Ô∏è‚É£ : √âV√âNEMENTS DISCORD üü¢             ‚ïë
‚ïë  Zone 6Ô∏è‚É£ : BACKUP & STABILIT√â VPS üü¢         ‚ïë
‚ïë  Zone 7Ô∏è‚É£ : COMMANDES ADMIN & MINI-DASHBOARD üü¢‚ïë
‚ïë  Zone 8Ô∏è‚É£ : LOGIN BOT ‚ö†Ô∏è                     ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
=================================================== */

require('dotenv').config();
const { Client, GatewayIntentBits } = require('discord.js');
const axios = require('axios');
const express = require('express');
const bodyParser = require('body-parser');
const sqlite3 = require('sqlite3').verbose();
const fs = require('fs');

const client = new Client({
  intents: [
    GatewayIntentBits.Guilds,
    GatewayIntentBits.GuildMessages,
    GatewayIntentBits.GuildMembers,
    GatewayIntentBits.MessageContent
  ]
});

const app = express();
app.use(bodyParser.json());

/* ===================================================
2Ô∏è‚É£ BASE DE DONN√âES SQLITE ‚ö†Ô∏è
=================================================== */
const db = new sqlite3.Database('./bot.db', (err) => {
  if (err) console.error("Erreur DB:", err.message);
});

db.run(`
  CREATE TABLE IF NOT EXISTS server_config (
    server_id TEXT PRIMARY KEY,
    welcome_message TEXT,
    mod_channel TEXT,
    ticket_channel_prefix TEXT,
    lang TEXT DEFAULT 'fr'
  )
`);

db.run(`
  CREATE TABLE IF NOT EXISTS lang_admins (
    server_id TEXT,
    user_id TEXT,
    PRIMARY KEY(server_id, user_id)
  )
`);

db.run(`
  CREATE TABLE IF NOT EXISTS mini_games_scores (
    server_id TEXT,
    user_id TEXT,
    game TEXT,
    score INTEGER,
    PRIMARY KEY(server_id, user_id, game)
  )
`);

/* ===================================================
3Ô∏è‚É£ CONFIG BOT & VARIABLES MODIFIABLES üü¢
=================================================== */
const AUTO_ROLE = "Membre";
const BOT_ADMIN_ROLE_DEFAULT = "Bot Admin";
let BOT_ADMIN_ROLE = BOT_ADMIN_ROLE_DEFAULT;

const memory = {};
const xpSystem = {};
const spamMap = new Map();
const gameChannels = {
  textOnly: [],
  imageOnly: [],
  videoOnly: []
};

const FORBIDDEN_WORDS = ["insulte1","insulte2"];
const FORBIDDEN_LINKS = ["discord.gg","bit.ly"];

/* ===================================================
4Ô∏è‚É£ FONCTIONS UTILITAIRES üü¢
=================================================== */
function addXP(userId) {
  if (!xpSystem[userId]) xpSystem[userId] = { xp: 0, level: 1 };
  xpSystem[userId].xp += Math.floor(Math.random() * 5) + 5;
  if (xpSystem[userId].xp >= xpSystem[userId].level * 100) {
    xpSystem[userId].xp = 0;
    xpSystem[userId].level++;
    return true;
  }
  return false;
}

function sanitize(text) {
  return text.replace(/https?:\/\/[^\s]+/g, '[link]');
}

function checkBotAdmin(member) {
  return member.roles.cache.some(r => r.name === BOT_ADMIN_ROLE);
}

/* ===================================================
5Ô∏è‚É£ √âV√âNEMENTS DISCORD üü¢
=================================================== */
client.on("guildMemberAdd", async member => {
  db.get(`SELECT welcome_message, lang FROM server_config WHERE server_id=?`, [member.guild.id], async (err,row)=>{
    const welcome = row?.welcome_message || `Bienvenue ${member.user.username} !`;
    await member.send(welcome);
  });
});

client.on("messageCreate", async message => {
  if (message.author.bot) return;

  const now = Date.now();
  const userData = spamMap.get(message.author.id) || { count:0, last:now };
  if (now - userData.last < 4000) {
    userData.count++;
    if (userData.count >= 5) {
      message.member.timeout(10*60*1000, "Spam d√©tect√©").catch(()=>{});
      return;
    }
  } else userData.count = 1;
  userData.last = now;
  spamMap.set(message.author.id, userData);

  if (gameChannels.textOnly.includes(message.channel.id) && message.attachments.size > 0) {
    await message.delete().catch(()=>{});
    return message.reply("üö´ Ce salon est r√©serv√© aux messages texte uniquement !");
  }
  if (gameChannels.imageOnly.includes(message.channel.id) && !message.attachments.some(a => a.contentType?.startsWith("image"))) {
    await message.delete().catch(()=>{});
    return message.reply("üö´ Ce salon est r√©serv√© aux images uniquement !");
  }
  if (gameChannels.videoOnly.includes(message.channel.id) && !message.attachments.some(a => a.contentType?.startsWith("video"))) {
    await message.delete().catch(()=>{});
    return message.reply("üö´ Ce salon est r√©serv√© aux vid√©os uniquement !");
  }

  addXP(message.author.id);
});

/* ===================================================
6Ô∏è‚É£ BACKUP & STABILIT√â VPS üü¢
=================================================== */
setInterval(() => {
  const backupPath = `./backup_bot_${Date.now()}.db`;
  fs.copyFile('./bot.db', backupPath, (err) => {
    if (err) console.error('üö® Erreur backup DB:', err);
    else console.log('Backup DB cr√©√© :', backupPath);
  });
}, 24*60*60*1000);

/* ===================================================
7Ô∏è‚É£ COMMANDES ADMIN & MINI-DASHBOARD üü¢
=================================================== */
client.on('interactionCreate', async interaction => {
  if (!interaction.isChatInputCommand()) return;

  if (interaction.commandName === 'set-bot-admin-role') {
    if (interaction.user.id !== interaction.guild.ownerId) 
      return interaction.reply({ content: 'üö® Seul le propri√©taire peut d√©finir le r√¥le.', ephemeral: true });
    const roleName = interaction.options.getString('role');
    BOT_ADMIN_ROLE = roleName;
    return interaction.reply(`‚úÖ R√¥le de contr√¥le total d√©fini sur : ${roleName}`);
  }

  const sensitiveCommands = ['reset-scores','configure-salon','set-welcome','set-ticket-prefix'];
  if (sensitiveCommands.includes(interaction.commandName)) {
    if (!checkBotAdmin(interaction.member)) {
      return interaction.reply({ content: 'üö® Vous n‚Äô√™tes pas autoris√© √† utiliser cette commande.', ephemeral: true });
    }
  }

  if (interaction.commandName === 'dashboard') {
    const embed = {
      color: 0x00ff99,
      title: `üìä Dashboard - ${interaction.guild.name}`,
      fields: [
        { name: "Membres", value: `${interaction.guild.memberCount}`, inline: true },
        { name: "R√¥le admin bot", value: BOT_ADMIN_ROLE, inline: true }
      ],
      timestamp: new Date()
    };
    return interaction.reply({ embeds: [embed], ephemeral: true });
  }
});

/* ===================================================
8Ô∏è‚É£ LOGIN BOT ‚ö†Ô∏è
=================================================== */
client.login(process.env.DISCORD_TOKEN)
  .then(() => console.log('Bot connect√© ‚úÖ'))
  .catch(err => console.error('üö® Erreur login bot:', err));

/* ===================================================
9Ô∏è‚É£ HEALTH CHECK pour Render ‚ö†Ô∏è
=================================================== */
app.get('/healthz', (req, res) => {
  res.status(200).send('OK');
});

// D√©marrage du serveur Express
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`Serveur Express lanc√© sur le port ${PORT}`));
